---
- name: Export status module config template
  template:
    src: mod-status.conf.j2
    dest: /etc/apache2/mods-available/status.conf
  become: yes
  when: ansible_os_family != 'RedHat'

- name: Enable status apache module for debian systems
  file:
    src: "{{ item.path }}"
    dest: "{{ item.dest }}"
    state: link
  with_items:
    - { path: '/etc/apache2/mods-available/status.load', dest: '/etc/apache2/mods-enabled/status.load'}
    - { path: '/etc/apache2/mods-available/status.conf', dest: '/etc/apache2/mods-enabled/status.conf'}
  become: yes
  notify:
    - Reload apache service
  when: ansible_os_family != 'RedHat'

- name: Enable status apache module for redhat systems
  blockinfile:
    path: /etc/httpd/conf/httpd.conf
    block: "{{ lookup('template', 'httpd.conf.j2') }}"
  become: yes
  notify:
    - Restart httpd service
  when: ansible_os_family == 'RedHat'

- name: Add apache integration to datadog config file
  template:
    src: apache.yaml.j2
    dest: /etc/datadog-agent/conf.d/apache.d/conf.yaml
  become: yes
  notify:
    - Restart datadog-agent service